<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Nunito:wght@400;500;600;700&family=Rufina:wght@400;700&display=swap"
      rel="stylesheet"
    />
    <title>Forest Reserve Tracker</title>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.css"
    />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.4.1/papaparse.min.js"></script>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      /* :root {
        --forest-dark: #1a4d2e;
        --forest-medium: #2d6a4f;
        --forest-light: #52b788;
        --forest-pale: #d8f3dc;
        --bg-light: #f8faf9;
        --bg-panel: #ffffff;
        --text-primary: #1e1e1e;
        --text-secondary: #5a5a5a;
        --text-muted: #8e8e8e;
        --blue-primary: #0066cc;
        --blue-light: #4d94ff;
        --red-primary: #d32f2f;
        --red-light: #e57373;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
        --border-radius: 12px;
        --transition: all 0.3s ease;
      } */

      :root {
        --prussian-blue: #080826ff;
        --muted-teal: #839788ff;
        --parchment: #efece8ff;
        --black-forest: #1a3a0fff;
        --berry-lipstick: #cf2a5eff
        --forest-dark: #1a3a0fff;
        --forest-medium: #2d6a4f;
        --forest-light: #52b788;
        --forest-pale: #d8f3dc;
        --bg-light: #f8faf9;
        --bg-panel: --parchment;
        --text-primary: #1a3a0fff;
        --text-secondary: #5a5a5a;
        --text-muted: #8e8e8e;
        --blue-primary: #0066cc;
        --blue-light: #4d94ff;
        --red-primary: #d32f2f;
        --red-light: #e57373;
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.08);
        --shadow-md: 0 4px 16px rgba(0, 0, 0, 0.12);
        --shadow-lg: 0 8px 24px rgba(0, 0, 0, 0.15);
        --border-radius: 12px;
        --transition: all 0.3s ease;
      }

      #body-container {
        font-family: "Nunito", -apple-system, BlinkMacSystemFont, sans-serif;
        height: 100vh;
        display: flex;
        flex-direction: row;
        background: var(--parchment);
        padding: 1vw;
        gap: 1vw;
      }

      #map {
        height: 100vh;
        width: 50%;
        border-radius: var(--border-radius);
        overflow: hidden;
        box-shadow: var(--shadow-lg);
        transition: var(--transition);
      }

      #panel {
        height: 100vh;
        width: 50%;
        overflow-y: auto;
        background: var(--parchment);
        padding: 32px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-lg);
      }

      #panel::-webkit-scrollbar {
        width: 8px;
      }

      #panel::-webkit-scrollbar-track {
        background: var(--forest-pale);
        border-radius: 4px;
      }

      #panel::-webkit-scrollbar-thumb {
        background: var(--forest-medium);
        border-radius: 4px;
      }

      #panel::-webkit-scrollbar-thumb:hover {
        background: var(--forest-dark);
      }

      /* Mobile responsive styles */
      @media (max-width: 768px) {
        #body-container {
          flex-direction: column;
          padding: 0;
          gap: 0;
        }
        #map {
          height: 50vh;
          width: 100%;
          border-radius: 0;
        }
        #panel {
          height: 50vh;
          width: 100%;
          border-radius: 0;
          padding: 20px;
        }
      }

      .panel-content {
        max-width: 1200px;
        margin: 0 auto;
      }

      .panel-header {
        font-family: "Rufina", serif;
        margin-bottom: 32px;
        padding-bottom: 24px;
        border-bottom: 3px solid var(--forest-pale);
      }

      .panel-header h2 {
        color: var(--forest-dark);
        font-size: 32px;
        font-weight: 700;
        margin-bottom: 8px;
        letter-spacing: -0.5px;
      }

      .panel-header p {
        color: var(--text-secondary);
        font-size: 16px;
        font-weight: 500;
      }

      .stats-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 20px;
        margin-bottom: 36px;
      }

      @media (max-width: 768px) {
        .stats-grid {
          grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
          gap: 12px;
          margin-bottom: 24px;
        }
      }

      .stat-card {
        background: linear-gradient(
          135deg,
          var(--forest-pale) 0%,
          #ffffff 100%
        );
        padding: 24px;
        border-radius: var(--border-radius);
        border-left: 5px solid var(--forest-medium);
        box-shadow: var(--shadow-sm);
        transition: var(--transition);
      }

      .stat-card:hover {
        transform: translateY(-4px);
        box-shadow: var(--shadow-md);
        border-left-color: var(--forest-light);
      }

      @media (max-width: 768px) {
        .stat-card {
          padding: 16px;
        }
      }

      .stat-label {
        font-size: 13px;
        color: var(--text-muted);
        text-transform: uppercase;
        letter-spacing: 0.5px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      @media (max-width: 768px) {
        .stat-label {
          font-size: 11px;
        }
      }

      .stat-value {
        font-size: 28px;
        font-weight: 700;
        color: var(--forest-dark);
        line-height: 1.2;
      }

      @media (max-width: 768px) {
        .stat-value {
          font-size: 22px;
        }
      }

      .stat-unit {
        font-size: 16px;
        color: var(--text-secondary);
        font-weight: 500;
      }

      @media (max-width: 768px) {
        .stat-unit {
          font-size: 14px;
        }
      }

      .chart-container {
        margin-bottom: 36px;
        background: white;
        padding: 28px;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
        border: 1px solid var(--forest-pale);
      }

      @media (max-width: 768px) {
        .chart-container {
          margin-bottom: 24px;
          padding: 20px;
        }
      }

      .chart-title {
        font-size: 18px;
        font-weight: 700;
        color: var(--text-primary);
        margin-bottom: 20px;
        font-family: "Rufina", serif;
        letter-spacing: -0.3px;
      }

      @media (max-width: 768px) {
        .chart-title {
          font-size: 16px;
          margin-bottom: 16px;
        }
      }

      table {
        width: 100%;
        border-collapse: separate;
        border-spacing: 0;
        background: white;
        box-shadow: var(--shadow-sm);
        border-radius: var(--border-radius);
        overflow: hidden;
        border: 1px solid var(--forest-pale);
      }

      th,
      td {
        padding: 16px;
        text-align: left;
        border-bottom: 1px solid #f0f0f0;
      }

      @media (max-width: 768px) {
        th,
        td {
          padding: 10px;
          font-size: 13px;
        }
      }

      th {
        background: linear-gradient(
          135deg,
          var(--forest-light) 0%,
          var(--forest-pale) 100%
        );
        color: white;
        font-weight: 700;
        font-size: 14px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        position: sticky;
        top: 0;
        z-index: 10;
      }

      tbody tr {
        transition: var(--transition);
      }

      tbody tr:hover {
        background-color: var(--forest-pale);
        transform: scale(1.01);
      }

      tbody tr:last-child td {
        border-bottom: none;
      }

      .positive {
        color: var(--blue-primary);
        font-weight: 600;
      }

      .negative {
        color: var(--red-primary);
        font-weight: 600;
      }

      .sortable {
        cursor: pointer;
        user-select: none;
        transition: var(--transition);
      }

      .sortable:hover {
        background: linear-gradient(
          135deg,
          var(--forest-medium) 0%,
          var(--forest-light) 100%
        );
      }

      .sortable::after {
        content: " ⇅";
        font-size: 12px;
        opacity: 0.6;
        margin-left: 4px;
      }

      .sortable.asc::after {
        content: " ▲";
        opacity: 1;
      }

      .sortable.desc::after {
        content: " ▼";
        opacity: 1;
      }

      .placeholder {
        text-align: center;
        padding: 60px 40px;
        color: var(--text-muted);
        background: linear-gradient(
          135deg,
          var(--forest-pale) 0%,
          #ffffff 100%
        );
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
      }

      .placeholder h3 {
        font-family: "Rufina", serif;
        color: var(--forest-medium);
        font-size: 22px;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .placeholder {
          padding: 30px 20px;
        }
        .placeholder h3 {
          font-size: 18px;
        }
      }

      .loading {
        text-align: center;
        padding: 60px 40px;
        color: var(--text-secondary);
      }

      .loading h3 {
        font-family: "Rufina", serif;
        color: var(--forest-medium);
        font-size: 22px;
        font-weight: 600;
      }

      @media (max-width: 768px) {
        .loading {
          padding: 30px 20px;
        }
        .loading h3 {
          font-size: 18px;
        }
      }

      .error {
        text-align: center;
        padding: 60px 40px;
        color: var(--red-primary);
        background: #ffebee;
        border-radius: var(--border-radius);
        box-shadow: var(--shadow-sm);
      }

      .error h3 {
        font-family: "Rufina", serif;
        font-size: 22px;
        font-weight: 600;
        margin-bottom: 8px;
      }

      @media (max-width: 768px) {
        .error {
          padding: 30px 20px;
        }
        .error h3 {
          font-size: 18px;
        }
      }

      .leaflet-popup-content-wrapper {
        border-radius: 10px;
        box-shadow: var(--shadow-md);
      }

      .popup-content {
        font-size: 14px;
        font-weight: 500;
        padding: 4px;
      }

      .popup-content strong {
        color: var(--forest-dark);
        font-weight: 700;
        font-size: 16px;
      }
    </style>
  </head>
  <body>
    <div id="body-container">
      <div id="map"></div>
      <div id="panel">
        <div class="panel-content">
          <div class="loading">
            <h3>Loading forest reserve data...</h3>
          </div>
        </div>
      </div>
    </div>

    <script>
      // GitHub raw URLs
      const GEOJSON_URL =
        "https://raw.githubusercontent.com/yhlreporter-a11y/forestreserveweb/refs/heads/main/HSK_Terengganu_small.geojson";
      const CSV_URL =
        "https://raw.githubusercontent.com/yhlreporter-a11y/forestreserveweb/refs/heads/main/terengganugazette-small.csv";

      // Initialize map centered on Peninsular Malaysia
      const map = L.map("map").setView([4.5, 102.5], 7);

      // Add OpenStreetMap tiles
      L.tileLayer(
        "https://tiles.stadiamaps.com/tiles/alidade_satellite/{z}/{x}/{y}{r}.{ext}",
        {
          minZoom: 0,
          maxZoom: 20,
          attribution:
            '&copy; CNES, Distribution Airbus DS, © Airbus DS, © PlanetObserver (Contains Copernicus Data) | &copy; <a href="https://www.stadiamaps.com/" target="_blank">Stadia Maps</a> &copy; <a href="https://openmaptiles.org/" target="_blank">OpenMapTiles</a> &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
          ext: "jpg",
        }
      ).addTo(map);

      // Store data
      let csvData = [];
      let geojsonData = null;
      let forestLayer = null;
      let currentChart = null;

      // Load data from GitHub
      async function loadData() {
        try {
          // Load GeoJSON
          const geojsonResponse = await fetch(GEOJSON_URL);
          if (!geojsonResponse.ok) {
            throw new Error(
              `Failed to load GeoJSON: ${geojsonResponse.status}`
            );
          }
          geojsonData = await geojsonResponse.json();
          console.log(
            "GeoJSON loaded:",
            geojsonData.features.length,
            "features"
          );

          // Load CSV
          const csvResponse = await fetch(CSV_URL);
          if (!csvResponse.ok) {
            throw new Error(`Failed to load CSV: ${csvResponse.status}`);
          }
          const csvText = await csvResponse.text();

          // Parse CSV
          Papa.parse(csvText, {
            header: true,
            dynamicTyping: true,
            skipEmptyLines: true,
            complete: function (results) {
              csvData = results.data;
              console.log("CSV data loaded:", csvData.length, "rows");

              // Initialize map with loaded data
              initializeMap();
            },
            error: function (error) {
              throw new Error(`Failed to parse CSV: ${error.message}`);
            },
          });
        } catch (error) {
          console.error("Error loading data:", error);
          document.getElementById("panel").innerHTML = `
            <div class="panel-content">
              <div class="error">
                <h3>Error loading data</h3>
                <p>${error.message}</p>
              </div>
            </div>
          `;
        }
      }

      function initializeMap() {
        // Add GeoJSON layer to map
        forestLayer = L.geoJSON(geojsonData, {
          style: function (feature) {
            return {
              fillColor: "#52b788",
              fillOpacity: 0.3,
              color: "#95d5b2",
              weight: 2,
            };
          },
          onEachFeature: function (feature, layer) {
            const props = feature.properties;

            // Create popup content
            const popupContent = `
              <div class="popup-content">
                <strong>${props.prf}</strong><br>
                ${props.MUKIM}, ${props.STATE}
                </div>
            `;

            layer.bindPopup(popupContent);

            // Add click handler
            layer.on("click", function () {
              updatePanel(props.prf, props.MUKIM, props.STATE);
            });

            // Highlight on hover
            layer.on("mouseover", function () {
              layer.setStyle({
                fillOpacity: 0.6,
                weight: 3,
                color: "#2d6a4f",
              });
            });

            layer.on("mouseout", function () {
              layer.setStyle({
                fillOpacity: 0.3,
                weight: 2,
                color: "#95d5b2",
              });
            });
          },
        }).addTo(map);

        // Fit map to show all reserves
        map.fitBounds(forestLayer.getBounds());

        // Invalidate map size after a brief delay to ensure proper rendering
        setTimeout(() => {
          map.invalidateSize();
        }, 100);

        // Update placeholder
        document.getElementById("panel").innerHTML = `
          <div class="panel-content">
            <div class="placeholder">
              <h3>Select a forest reserve on the map to view details</h3>
            </div>
          </div>
        `;
      }

      function updatePanel(reserveName, district, state) {
        // Filter data for this reserve
        const reserveData = csvData.filter((row) => row.PRF === reserveName);

        if (reserveData.length === 0) {
          document.getElementById("panel").innerHTML = `
            <div class="panel-content">
              <div class="placeholder">
                <h3>No data available for ${reserveName}</h3>
              </div>
            </div>
          `;
          return;
        }

        // Calculate net change
        const netChange = reserveData.reduce((sum, row) => {
          return sum + (row.ADD || 0) - (row.REMOVE || 0);
        }, 0);

        // Calculate yearly changes
        const yearlyChanges = {};
        reserveData.forEach((row) => {
          const year = row.YEAR;
          if (!yearlyChanges[year]) {
            yearlyChanges[year] = 0;
          }
          yearlyChanges[year] += (row.ADD || 0) - (row.REMOVE || 0);
        });

        // Create complete year range from 2001 to 2025
        const allYears = [];
        for (let year = 2001; year <= 2025; year++) {
          allYears.push(year.toString());
        }

        // Map changes to all years (0 for years with no data)
        const changes = allYears.map((year) => yearlyChanges[year] || 0);

        // Get all changes (additions and removals)
        const allChanges = [];
        reserveData.forEach((row) => {
          if (row.ADD > 0) {
            allChanges.push({
              date: `${row.DAY}/${row.MONTH}/${row.YEAR}`,
              dateSort: new Date(row.YEAR, row.MONTH - 1, row.DAY),
              change: row.ADD,
              gazette: row.GAZETTENUM,
            });
          }
          if (row.REMOVE > 0) {
            allChanges.push({
              date: `${row.DAY}/${row.MONTH}/${row.YEAR}`,
              dateSort: new Date(row.YEAR, row.MONTH - 1, row.DAY),
              change: -row.REMOVE,
              gazette: row.GAZETTENUM,
            });
          }
        });

        // Sort by date (most recent first)
        allChanges.sort((a, b) => b.dateSort - a.dateSort);

        // Update panel HTML
        const panelHTML = `
          <div class="panel-content">
            <div class="panel-header">
              <h2>${reserveName}</h2>
            <p>${district}, ${state}</p>
            </div>

            <div class="stats-grid">
              <div class="stat-card">
                <div class="stat-label">Net Change Since 2001</div>
                <div class="stat-value ${
                  netChange >= 0 ? "positive" : "negative"
                }">
                  ${netChange >= 0 ? "+" : ""}${netChange.toFixed(2)}
                  <span class="stat-unit">ha</span>
                </div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Total Records</div>
                <div class="stat-value">${reserveData.length}</div>
              </div>
              <div class="stat-card">
                <div class="stat-label">Years Tracked</div>
                <div class="stat-value">${
                  Object.keys(yearlyChanges).length
                }</div>
              </div>
            </div>

            <div class="chart-container">
              <div class="chart-title">Yearly Net Changes in Area (hectares)</div>
              <canvas id="yearlyChart"></canvas>
            </div>

            <div class="chart-title">All Changes</div>
            <table id="changesTable">
              <thead>
                <tr>
                  <th class="sortable" data-column="date">Date</th>
                  <th class="sortable" data-column="change">Change (ha)</th>
                  <th>Gazette No.</th>
                </tr>
              </thead>
              <tbody>
                ${
                  allChanges.length > 0
                    ? allChanges
                        .map(
                          (item) => `
                    <tr>
                      <td>${item.date}</td>
                      <td class="${
                        item.change >= 0 ? "positive" : "negative"
                      }">${item.change >= 0 ? "+" : ""}${item.change.toFixed(
                            2
                          )}</td>
                      <td>${item.gazette}</td>
                    </tr>
                  `
                        )
                        .join("")
                    : '<tr><td colspan="3" style="text-align:center;">No changes recorded</td></tr>'
                }
              </tbody>
            </table>
          </div>
        `;

        document.getElementById("panel").innerHTML = panelHTML;

        // Add sorting functionality
        let currentSort = { column: "date", direction: "desc" };
        let changesData = [...allChanges];

        function sortTable(column) {
          const table = document.getElementById("changesTable");
          const headers = table.querySelectorAll("th.sortable");

          // Toggle direction if same column, otherwise default to desc
          if (currentSort.column === column) {
            currentSort.direction =
              currentSort.direction === "asc" ? "desc" : "asc";
          } else {
            currentSort.column = column;
            currentSort.direction = "desc";
          }

          // Sort data
          changesData.sort((a, b) => {
            let aVal, bVal;
            if (column === "date") {
              aVal = a.dateSort;
              bVal = b.dateSort;
            } else if (column === "change") {
              aVal = a.change;
              bVal = b.change;
            }

            if (currentSort.direction === "asc") {
              return aVal > bVal ? 1 : -1;
            } else {
              return aVal < bVal ? 1 : -1;
            }
          });

          // Update header classes
          headers.forEach((header) => {
            header.classList.remove("asc", "desc");
            if (header.dataset.column === column) {
              header.classList.add(currentSort.direction);
            }
          });

          // Update table body
          const tbody = table.querySelector("tbody");
          tbody.innerHTML = changesData
            .map(
              (item) => `
            <tr>
              <td>${item.date}</td>
              <td class="${item.change >= 0 ? "positive" : "negative"}">${
                item.change >= 0 ? "+" : ""
              }${item.change.toFixed(2)}</td>
              <td>${item.gazette}</td>
            </tr>
          `
            )
            .join("");
        }

        // Attach click handlers to sortable headers
        const sortableHeaders = document.querySelectorAll("th.sortable");
        sortableHeaders.forEach((header) => {
          header.addEventListener("click", () => {
            sortTable(header.dataset.column);
          });
        });

        // Set initial sort indicator
        const dateHeader = document.querySelector('th[data-column="date"]');
        if (dateHeader) {
          dateHeader.classList.add("desc");
        }

        // Create chart
        const ctx = document.getElementById("yearlyChart").getContext("2d");

        // Destroy previous chart if exists
        if (currentChart) {
          currentChart.destroy();
        }

        currentChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: allYears,
            datasets: [
              {
                label: "Net Change (ha)",
                data: changes,
                backgroundColor: changes.map((val) =>
                  val >= 0 ? "#007bff" : "#dc3545"
                ),
                borderColor: changes.map((val) =>
                  val >= 0 ? "#0056b3" : "#bd2130"
                ),
                borderWidth: 1,
                borderRadius: 4,
              },
            ],
          },
          options: {
            responsive: true,
            maintainAspectRatio: true,
            plugins: {
              legend: {
                display: false,
              },
              tooltip: {
                backgroundColor: "rgba(0, 0, 0, 0.8)",
                padding: 12,
                cornerRadius: 8,
                titleFont: {
                  size: 14,
                  weight: "bold",
                },
                bodyFont: {
                  size: 13,
                },
              },
            },
            scales: {
              x: {
                grid: {
                  display: false,
                },
                ticks: {
                  font: {
                    size: 11,
                  },
                },
              },
              y: {
                beginAtZero: true,
                grid: {
                  color: "rgba(0, 0, 0, 0.05)",
                },
                ticks: {
                  callback: function (value) {
                    return value;
                  },
                  font: {
                    size: 12,
                  },
                },
              },
            },
          },
        });
      }

      // Handle window resize for map
      window.addEventListener("resize", () => {
        if (map) {
          setTimeout(() => {
            map.invalidateSize();
          }, 100);
        }
      });

      // Load data when page loads
      loadData();
    </script>
  </body>
</html>
